<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹äº®ä¸­å›½Â·ç‚¹äº®ä¸Šæµ· - æ— éšœç¢æ—…æ¸¸å¹³å°</title>
    <meta name="description" content="ç‚¹äº®ä¸­å›½æ—…æ¸¸å¹³å°ï¼Œä¸ºæ‚¨æä¾›å…¨å›½çº¢è‰²æ—…æ¸¸ã€ç¾é£Ÿæ‰“å¡ã€æ— éšœç¢æœåŠ¡ç­‰ç»¼åˆæ—…æ¸¸ä¿¡æ¯">
    <meta name="keywords" content="æ—…æ¸¸,çº¢è‰²æ—…æ¸¸,æ— éšœç¢,ç¾é£Ÿ,æ™¯ç‚¹,å¿—æ„¿æœåŠ¡">
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Google Maps CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/google-map.css') }}">
    
    <!-- Google Maps JavaScript API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=visualization">
    </script>
    
    <!-- æ™¯ç‚¹å·¥å…·å‡½æ•° -->
    <script src="{{ url_for('static', filename='js/attractions-utils.js') }}"></script>
    
    <!-- Google Maps æ§åˆ¶å™¨ -->
    <script src="{{ url_for('static', filename='js/google-map.js') }}"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-content">
            <a href="{{ url_for('main.index') }}" class="logo">ğŸŒŸ ç‚¹äº®ä¸­å›½</a>
            
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="æœç´¢åŸå¸‚æˆ–æ™¯ç‚¹..." id="searchInput">
                <button class="search-btn" id="searchBtn">ğŸ”</button>
            </div>
            
            <nav class="user-menu">
                <a href="#" id="loginBtn">ç™»å½•</a>
                <a href="#" id="registerBtn">æ³¨å†Œ</a>
                <a href="#routes">è·¯çº¿æ¨è</a>
                <a href="#volunteers">å¿—æ„¿æœåŠ¡</a>
            </nav>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- åœ°å›¾å®¹å™¨ -->
        <section class="map-container">
            <div class="map-header">
                <h1 class="map-title">ç‚¹äº®ä¸­å›½Â·å…¨å›½æ—…æ¸¸çƒ­åº¦åœ°å›¾</h1>
                <div class="map-controls">
                    <button class="control-btn back-btn hidden" id="backBtn">ğŸ”™ è¿”å›å…¨å›½</button>
                    <button class="control-btn" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
                    <button class="control-btn" id="fullscreenBtn">ğŸ” å…¨å±</button>
                    <button class="control-btn" id="add-marker-btn" onclick="mapController.toggleAddMarkerMode()">ğŸ“ æ·»åŠ æ ‡è®°</button>
                    <button class="control-btn" id="clear-markers-btn" onclick="mapController.clearAllUserMarkers()">ğŸ—‘ï¸ æ¸…é™¤æ ‡è®°</button>
                </div>
            </div>
            
            <!-- æ™¯ç‚¹ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-categories">
                    <button class="filter-btn active" data-type="all">ğŸ—ºï¸ å…¨éƒ¨æ™¯ç‚¹</button>
                    <button class="filter-btn" data-type="red">ğŸš© çº¢è‰²æ—…æ¸¸</button>
                    <button class="filter-btn" data-type="food">ğŸœ ç¾é£Ÿåœ°å›¾</button>
                    <button class="filter-btn" data-type="history">ğŸ›ï¸ å†å²åœ°æ ‡</button>
                </div>
                <div class="filter-info">
                    <span id="filterCount">æ˜¾ç¤ºå…¨éƒ¨æ™¯ç‚¹</span>
                </div>
            </div>
            
            <div id="map"></div>
        </section>

        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
        <aside class="right-panel">
            <!-- åŸå¸‚ä¿¡æ¯å¡ç‰‡ -->
            <div class="panel-card city-info" id="cityInfo">
                <div class="panel-header">
                    <span>ğŸ™ï¸ åŸå¸‚ä¿¡æ¯</span>
                </div>
                <div class="panel-content">
                    <h2 class="city-name">é€‰æ‹©ä¸€ä¸ªåŸå¸‚</h2>
                    <div class="city-stats">
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æ™¯ç‚¹æ•°é‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æ¨èè·¯çº¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">å¿—æ„¿æœåŠ¡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æ¸¸å®¢æ‰“å¡</div>
                        </div>
                    </div>
                    
                    <h3 class="section-title">ğŸ¯ çƒ­é—¨æ™¯ç‚¹</h3>
                    <div class="attraction-list">
                        <div class="placeholder-text">
                            ç‚¹å‡»åœ°å›¾ä¸Šçš„åŸå¸‚æŸ¥çœ‹æ™¯ç‚¹ä¿¡æ¯
                        </div>
                    </div>
                </div>
            </div>

            <!-- å…¨å›½æ’è¡Œæ¦œ -->
            <div class="panel-card">
                <div class="panel-header">
                    <span>ğŸ† çƒ­é—¨åŸå¸‚æ’è¡Œæ¦œ</span>
                </div>
                <div class="panel-content">
                    <div class="ranking-list">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½å¿«æ·å…¥å£ -->
            <div class="panel-card">
                <div class="panel-header">
                    <span>ğŸš€ å¿«æ·åŠŸèƒ½</span>
                </div>
                <div class="panel-content">
                    <div class="quick-actions">
                        <button class="control-btn quick-action-btn" onclick="window.location.href='/routes'">
                            ğŸ—ºï¸ è·¯çº¿è§„åˆ’
                        </button>
                        <button class="control-btn quick-action-btn" onclick="window.location.href='/volunteers'">
                            ğŸ¤ å¿—æ„¿æœåŠ¡
                        </button>
                        <button class="control-btn quick-action-btn" onclick="window.location.href='/attractions'">
                            ğŸ›ï¸ æ™¯ç‚¹å¤§å…¨
                        </button>
                        <button class="control-btn quick-action-btn" onclick="window.location.href='/reviews'">
                            â­ ç”¨æˆ·è¯„ä»·
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Â© 2024 ç‚¹äº®ä¸­å›½Â·ç‚¹äº®ä¸Šæµ· æ— éšœç¢æ—…æ¸¸å¹³å°</p>
            <p class="footer-links">
                è‡´åŠ›äºä¸ºæ‰€æœ‰äººæä¾›å¹³ç­‰ã€ä¾¿æ·çš„æ—…æ¸¸ä½“éªŒ | 
                <a href="#" class="footer-link">å…³äºæˆ‘ä»¬</a> | 
                <a href="#" class="footer-link">è”ç³»æˆ‘ä»¬</a> | 
                <a href="#" class="footer-link">éšç§æ”¿ç­–</a>
            </p>
        </div>
    </footer>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ç”¨æˆ·ç™»å½•</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å:</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group-last">
                    <label class="form-label">å¯†ç :</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn-primary">ç™»å½•</button>
                    <button type="button" id="closeModal" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
            <p class="test-info">
                æµ‹è¯•è´¦å·: admin/admin123, tourist1/password123
            </p>
        </div>
    </div>

    <!-- JavaScript æ–‡ä»¶ -->
    
    <script>
        // é¡µé¢äº¤äº’åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // ç™»å½•æ¨¡æ€æ¡†æ§åˆ¶
            const loginBtn = document.getElementById('loginBtn');
            const loginModal = document.getElementById('loginModal');
            const closeModal = document.getElementById('closeModal');
            const loginForm = document.getElementById('loginForm');
            
            loginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.style.display = 'block';
            });
            
            closeModal.addEventListener('click', () => {
                loginModal.style.display = 'none';
            });
            
            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.style.display = 'none';
                }
            });
            
            // ç™»å½•è¡¨å•æäº¤
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('ç™»å½•æˆåŠŸï¼');
                        localStorage.setItem('token', data.access_token);
                        loginModal.style.display = 'none';
                        
                        // æ›´æ–°ç”¨æˆ·èœå•
                        const userMenu = document.querySelector('.user-menu');
                        userMenu.innerHTML = `
                            <span style="color: white;">æ¬¢è¿, ${data.user.username}</span>
                            <a href="#" id="logoutBtn">é€€å‡º</a>
                        `;
                        
                        // ç»‘å®šé€€å‡ºäº‹ä»¶
                        document.getElementById('logoutBtn').addEventListener('click', (e) => {
                            e.preventDefault();
                            localStorage.removeItem('token');
                            location.reload();
                        });
                    } else {
                        alert(data.message || 'ç™»å½•å¤±è´¥');
                    }
                } catch (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            });
            
            // åˆ·æ–°æŒ‰é’®
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', () => {
                if (window.mapController) {
                    if (window.mapController.currentView === 'china') {
                        window.mapController.initChinaMap();
                    } else {
                        location.reload();
                    }
                }
            });
            
            // å…¨å±æŒ‰é’®
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            fullscreenBtn.addEventListener('click', () => {
                const mapContainer = document.querySelector('.map-container');
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.webkitRequestFullscreen) {
                    mapContainer.webkitRequestFullscreen();
                } else if (mapContainer.msRequestFullscreen) {
                    mapContainer.msRequestFullscreen();
                }
            });
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (token) {
                // éªŒè¯tokenæœ‰æ•ˆæ€§
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        const userMenu = document.querySelector('.user-menu');
                        userMenu.innerHTML = `
                            <span style="color: white;">æ¬¢è¿, ${data.user.username}</span>
                            <a href="#" id="logoutBtn">é€€å‡º</a>
                        `;
                        
                        document.getElementById('logoutBtn').addEventListener('click', (e) => {
                            e.preventDefault();
                            localStorage.removeItem('token');
                            location.reload();
                        });
                    }
                })
                .catch(error => {
                    console.error('TokenéªŒè¯å¤±è´¥:', error);
                    localStorage.removeItem('token');
                });
            }
        });
    </script>
</body>
</html>