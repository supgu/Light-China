<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ attraction.name }} - {{ attraction.address.split()[0] if attraction.address else 'æœªçŸ¥' }} - ç‚¹äº®ä¸­å›½</title>
    <meta name="description" content="{{ attraction.description }}">
    <meta name="keywords" content="{{ attraction.name }}, {{ attraction.address.split()[0] if attraction.address else 'æœªçŸ¥' }}, æ—…æ¸¸, æ™¯ç‚¹, ç‚¹äº®ä¸­å›½">
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/attraction.css') }}">
    
    <!-- åœ°å›¾åº“ -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=YOUR_AMAP_KEY"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-content">
            <a href="{{ url_for('main.index') }}" class="logo">ğŸŒŸ ç‚¹äº®ä¸­å›½</a>
            
            <div class="breadcrumb">
                <a href="{{ url_for('main.index') }}">é¦–é¡µ</a>
                <span class="separator">></span>
                <a href="{{ url_for('main.index') }}">{{ attraction.address.split()[0] if attraction.address else 'æœªçŸ¥' }}</a>
                <span class="separator">></span>
                <span class="current">{{ attraction.name }}</span>
            </div>
            
            <nav class="user-menu">
                <a href="#" id="loginBtn">ç™»å½•</a>
                <a href="#" id="shareBtn" class="share-btn">ğŸ“¤ åˆ†äº«</a>
                <a href="#" id="favoriteBtn" class="favorite-btn">â¤ï¸ æ”¶è—</a>
            </nav>
        </div>
    </header>

    <!-- æ™¯ç‚¹ä¸»è¦ä¿¡æ¯åŒºåŸŸ -->
    <main class="attraction-main">
        <!-- å·¦ä¾§å›¾ç‰‡å’ŒåŸºæœ¬ä¿¡æ¯ -->
        <div class="attraction-left">
            <!-- å›¾ç‰‡è½®æ’­ -->
            <div class="image-gallery">
                <div class="main-image">
                    <img id="mainImage" src="{{ attraction.images[0] if attraction.images else '/static/images/default-attraction.jpg' }}" alt="{{ attraction.name }}" width="800" height="600">
                    <div class="image-overlay">
                        <div class="image-counter">
                            <span id="currentImageIndex">1</span> / <span id="totalImages">{{ attraction.images|length or 1 }}</span>
                        </div>
                        <div class="image-controls">
                            <button class="img-btn prev-btn" id="prevImage">â€¹</button>
                            <button class="img-btn next-btn" id="nextImage">â€º</button>
                        </div>
                    </div>
                </div>
                
                {% if attraction.images and attraction.images|length > 1 %}
                <div class="thumbnail-list">
                    {% for image in attraction.images %}
                    <img class="thumbnail {{ 'active' if loop.first else '' }}" 
                         src="{{ image }}" 
                         alt="{{ attraction.name }}å›¾ç‰‡{{ loop.index }}"
                         width="120" height="90"
                         onclick="changeMainImage({{ loop.index0 }})">
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="info-card">
                <div class="attraction-header">
                    <h1 class="attraction-title">{{ attraction.name }}</h1>
                    <div class="attraction-badges">
                        <span class="category-badge">{{ attraction.category_name }}</span>
                        {% if attraction.accessibility %}
                        <span class="accessibility-badge">â™¿ æ— éšœç¢å‹å¥½</span>
                        {% endif %}
                        {% if attraction.is_free %}
                        <span class="free-badge">ğŸ†“ å…è´¹</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="rating-section">
                    <div class="rating-display">
                        <span class="rating-score">{{ attraction.rating }}</span>
                        <div class="stars">
                            {% for i in range(5) %}
                            <span class="star {{ 'filled' if i < (attraction.rating|round) else '' }}">â­</span>
                            {% endfor %}
                        </div>
                        <span class="rating-count">({{ attraction.reviews_count }}æ¡è¯„ä»·)</span>
                    </div>
                    <div class="rating-actions">
                        <button class="btn btn-primary btn-sm" id="writeReviewBtn">ğŸ’¬ å†™è¯„è®º</button>
                        <button class="btn btn-outline btn-sm" id="viewReviewsBtn" onclick="document.querySelector('.reviews-section').scrollIntoView({behavior: 'smooth'})">ğŸ“– æŸ¥çœ‹è¯„è®º</button>
                    </div>
                </div>

                <div class="quick-info">
                    <div class="info-item">
                        <span class="info-icon">ğŸ“</span>
                        <div class="info-content">
                            <div class="info-label">åœ°å€</div>
                            <div class="info-value">{{ attraction.address }}</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">ğŸ•’</span>
                        <div class="info-content">
                            <div class="info-label">å¼€æ”¾æ—¶é—´</div>
                            <div class="info-value">{{ attraction.opening_hours or 'è¯·å’¨è¯¢æ™¯ç‚¹' }}</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-icon">ğŸ’°</span>
                        <div class="info-content">
                            <div class="info-label">é—¨ç¥¨ä»·æ ¼</div>
                            <div class="info-value">{{ attraction.ticket_price or 'å…è´¹' }}</div>
                        </div>
                    </div>
                    
                    {% if attraction.phone %}
                    <div class="info-item">
                        <span class="info-icon">ğŸ“</span>
                        <div class="info-content">
                            <div class="info-label">è”ç³»ç”µè¯</div>
                            <div class="info-value">{{ attraction.phone }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="getDirectionsBtn">
                        ğŸ§­ è·å–è·¯çº¿
                    </button>
                    <button class="btn btn-secondary" id="addToRouteBtn">
                        â• åŠ å…¥è¡Œç¨‹
                    </button>
                    <button class="btn btn-accent" id="writeReviewBtn2">
                        ğŸ’¬ å†™è¯„è®º
                    </button>
                    <button class="btn btn-outline" id="checkinBtn">
                        ğŸ“¸ æ‰“å¡ç­¾åˆ°
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§è¯¦ç»†ä¿¡æ¯ -->
        <div class="attraction-right">
            <!-- è¯¦ç»†æè¿° -->
            <div class="detail-card">
                <h2 class="section-title">ğŸ“– æ™¯ç‚¹ä»‹ç»</h2>
                <div class="description-content">
                    <p>{{ attraction.description }}</p>
                    {% if attraction.history %}
                    <h3>å†å²èƒŒæ™¯</h3>
                    <p>{{ attraction.history }}</p>
                    {% endif %}
                    {% if attraction.highlights %}
                    <h3>æ¸¸è§ˆäº®ç‚¹</h3>
                    <ul>
                        {% for highlight in attraction.highlights %}
                        <li>{{ highlight }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>

            <!-- æ— éšœç¢è®¾æ–½ä¿¡æ¯ -->
            {% if attraction.accessibility_info %}
            <div class="detail-card accessibility-card">
                <h2 class="section-title">â™¿ æ— éšœç¢è®¾æ–½</h2>
                <div class="accessibility-info">
                    {% for facility in attraction.accessibility_info %}
                    <div class="facility-item">
                        <span class="facility-icon">{{ facility.icon }}</span>
                        <span class="facility-name">{{ facility.name }}</span>
                        <span class="facility-status {{ 'available' if facility.available else 'unavailable' }}">
                            {{ 'âœ… å¯ç”¨' if facility.available else 'âŒ ä¸å¯ç”¨' }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ä½ç½®åœ°å›¾ -->
            <div class="detail-card">
                <h2 class="section-title">ğŸ“ ä½ç½®ä¿¡æ¯</h2>
                <div id="attractionMap" class="attraction-map"></div>
                <div class="map-info">
                    <p><strong>è¯¦ç»†åœ°å€ï¼š</strong>{{ attraction.address }}</p>
                    {% if attraction.transportation %}
                    <p><strong>äº¤é€šæŒ‡å—ï¼š</strong>{{ attraction.transportation }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- é™„è¿‘æ¨è -->
            <div class="detail-card">
                <h2 class="section-title">ğŸ¯ é™„è¿‘æ¨è</h2>
                <div class="nearby-attractions">
                    {% for nearby in nearby_attractions %}
                    <div class="nearby-item" onclick="window.location.href='{{ url_for('attractions.get_attraction_detail', attraction_id=nearby.id) }}'">'
                        <img src="{{ nearby.image or '/static/images/default-attraction.jpg' }}" alt="{{ nearby.name }}" width="200" height="150">
                        <div class="nearby-info">
                            <h4>{{ nearby.name }}</h4>
                            <p>{{ nearby.description[:50] }}...</p>
                            <div class="nearby-meta">
                                <span class="distance">{{ nearby.distance }}km</span>
                                <span class="rating">â­ {{ nearby.rating }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>

    <!-- ç”¨æˆ·è¯„è®ºåŒºåŸŸ -->
    <section class="reviews-section">
        <div class="reviews-container">
            <div class="reviews-header">
                <h2>ğŸ’¬ ç”¨æˆ·è¯„ä»· ({{ attraction.reviews_count }})</h2>
                <div class="reviews-stats">
                    <div class="rating-breakdown">
                        {% for i in range(5, 0, -1) %}
                        <div class="rating-bar">
                            <span class="rating-label">{{ i }}æ˜Ÿ</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: {{ (rating_distribution[i] or 0) }}%"></div>
                            </div>
                            <span class="rating-percent">{{ (rating_distribution[i] or 0) }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- è¯„è®ºç­›é€‰ -->
            <div class="reviews-filter">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="5">5æ˜Ÿ</button>
                <button class="filter-btn" data-filter="4">4æ˜Ÿ</button>
                <button class="filter-btn" data-filter="3">3æ˜Ÿ</button>
                <button class="filter-btn" data-filter="with-images">æœ‰å›¾</button>
                <button class="filter-btn" data-filter="accessibility">æ— éšœç¢</button>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="reviews-list">
                {% for review in reviews %}
                <div class="review-item" data-rating="{{ review.rating }}">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <img src="{{ review.user.avatar or '/static/images/default-avatar.jpg' }}" alt="{{ review.user.username }}" class="reviewer-avatar" width="50" height="50">
                            <div class="reviewer-details">
                                <div class="reviewer-name">{{ review.user.username }}</div>
                                <div class="review-date">{{ review.created_at.strftime('%Y-%m-%d') }}</div>
                            </div>
                        </div>
                        <div class="review-rating">
                            {% for i in range(5) %}
                            <span class="star {{ 'filled' if i < review.rating else '' }}">â­</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="review-content">
                        <p>{{ review.content }}</p>
                        {% if review.images %}
                        <div class="review-images">
                            {% for image in review.images %}
                            <img src="{{ image }}" alt="ç”¨æˆ·å›¾ç‰‡" class="review-image" onclick="showImageModal('{{ image }}')" width="100" height="100">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="review-actions">
                        <button class="action-btn" onclick="likeReview({{ review.id }})">
                            ğŸ‘ <span class="like-count">{{ review.likes_count }}</span>
                        </button>
                        <button class="action-btn" onclick="replyReview({{ review.id }})">
                            ğŸ’¬ å›å¤
                        </button>
                        <button class="action-btn" onclick="reportReview({{ review.id }})">
                            ğŸš¨ ä¸¾æŠ¥
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- åŠ è½½æ›´å¤š -->
            <div class="load-more">
                <button class="btn btn-outline" id="loadMoreReviews">åŠ è½½æ›´å¤šè¯„è®º</button>
            </div>
        </div>
    </section>

    <!-- å†™è¯„ä»·æ¨¡æ€æ¡† -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœï¸ å†™è¯„ä»·</h3>
                <button class="close-btn" id="closeReviewModal">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="form-group">
                        <label>è¯„åˆ†ï¼š</label>
                        <div class="rating-input">
                            {% for i in range(1, 6) %}
                            <span class="rating-star" data-rating="{{ i }}">â­</span>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="reviewRating" name="rating" required>
                    </div>
                    
                    <div class="form-group">
                        <label>è¯„ä»·å†…å®¹ï¼š</label>
                        <textarea id="reviewContent" name="content" rows="5" placeholder="åˆ†äº«æ‚¨çš„æ¸¸è§ˆä½“éªŒ..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>ä¸Šä¼ å›¾ç‰‡ï¼š</label>
                        <div class="image-upload">
                            <input type="file" id="reviewImages" name="images" multiple accept="image/*">
                            <div class="upload-preview" id="uploadPreview"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="accessibilityReview" name="accessibility">
                            è¿™æ˜¯ä¸€æ¡å…³äºæ— éšœç¢è®¾æ–½çš„è¯„ä»·
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">å‘å¸ƒè¯„ä»·</button>
                        <button type="button" class="btn btn-secondary" id="cancelReview">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ‰“å¡æ¨¡æ€æ¡† -->
    <div id="checkinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¸ æ™¯ç‚¹æ‰“å¡</h3>
                <button class="close-btn" id="closeCheckinModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="checkin-form">
                    <div class="camera-section">
                        <video id="cameraPreview" autoplay></video>
                        <canvas id="photoCanvas" class="hidden"></canvas>
                        <div class="camera-controls">
                            <button class="btn btn-primary" id="takePhotoBtn">ğŸ“· æ‹ç…§</button>
                            <button class="btn btn-secondary" id="uploadPhotoBtn">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                            <input type="file" id="photoUpload" accept="image/*" class="hidden">
                        </div>
                    </div>
                    
                    <div class="checkin-info">
                        <h4>{{ attraction.name }}</h4>
                        <p>ğŸ“ {{ attraction.address }}</p>
                        <p>ğŸ•’ {{ current_time.strftime('%Y-%m-%d %H:%M') if current_time else '' }}</p>
                        
                        <div class="checkin-message">
                            <textarea placeholder="åˆ†äº«æ­¤åˆ»çš„å¿ƒæƒ…..." id="checkinMessage"></textarea>
                        </div>
                        
                        <div class="checkin-actions">
                            <button class="btn btn-primary" id="submitCheckinBtn">âœ… å®Œæˆæ‰“å¡</button>
                            <button class="btn btn-secondary" id="cancelCheckinBtn">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/attraction.js') }}"></script>
    <script>
        // æ™¯ç‚¹æ•°æ®
        const attractionData = {
            id: {{ attraction.id }},
            name: "{{ attraction.name }}",
            address: "{{ attraction.address or '' }}",
            latitude: {{ attraction.latitude or 0 }},
            longitude: {{ attraction.longitude or 0 }}
        };
        const nearbyAttractions = [
            {% for nearby in nearby_attractions %}
            {
                id: {{ nearby.id }},
                name: "{{ nearby.name }}",
                latitude: {{ nearby.latitude or 0 }},
                longitude: {{ nearby.longitude or 0 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å›¾ç‰‡è½®æ’­
            initImageGallery();
            
            // åˆå§‹åŒ–åœ°å›¾
            initAttractionMap();
            
            // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½
            initReviewSystem();
            
            // åˆå§‹åŒ–æ‰“å¡åŠŸèƒ½
            initCheckinSystem();
            
            // åŠ è½½ç”¨æˆ·çŠ¶æ€
            loadUserStatus();
        });
    </script>
</body>
</html>